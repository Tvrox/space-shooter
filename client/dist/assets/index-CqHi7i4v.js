(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const r={playerName:"",score:0,lives:3,paused:!1,gameOver:!1};let p,T;function Q(t){p=t}function V(t){T=t}function Z(){if(!(!p||!T)){p.fillStyle="white",p.font="20px Arial",p.fillText("Очки: "+r.score,10,30);for(let t=0;t<r.lives;t++)p.drawImage(T.heart,600-(t+1)*30-10,10,24,24)}}function _(t){document.getElementById("finalScoreText").textContent=`Ваши очки: ${t}`,document.getElementById("endModal").style.display="block"}class ee{constructor(e=300,n=300){this.x=e,this.y=n}reset(){this.x=300,this.y=300}moveWithMouse(e,n,o){const s=i=>{if(!n()&&this.awaitingMouseSync){const u=e.getBoundingClientRect(),v=i.clientX-u.left,I=i.clientY-u.top;this.x=v*e.width/u.width-25,this.y=I*e.height/u.height-13,this.clamp(e),o(!0),this.awaitingMouseSync=!1}if(!n())return;const a=e.getBoundingClientRect(),g=i.clientX-a.left,E=i.clientY-a.top;this.x=g*e.width/a.width-25,this.y=E*e.height/a.height-13,this.clamp(e)};this.awaitingMouseSync=!1,e.addEventListener("mousemove",s),e.addEventListener("mousedown",()=>{n()||(this.awaitingMouseSync=!0)})}moveWithKeyboard(e,n){(e.w||e.ArrowUp)&&(this.y-=4),(e.s||e.ArrowDown)&&(this.y+=4),(e.a||e.ArrowLeft)&&(this.x-=4),(e.d||e.ArrowRight)&&(this.x+=4),this.clamp(n)}clamp(e){this.x=Math.max(0,Math.min(e.width-50,this.x)),this.y=Math.max(0,Math.min(e.height-50,this.y))}}const te=t=>new Promise((e,n)=>{const o=new Image;o.src=t,o.onload=()=>e(o),o.onerror=()=>n(new Error(`Не удалось загрузить: ${t}`))});async function ne(){const t={ship:"/images/ship01.png",fire:"/images/fire.png",aster:"/images/astero.png",expl:"/images/expl222.png",heart:"/images/heart.png"},e={};for(const[n,o]of Object.entries(t))e[n]=await te(o);return e}const l={background:new Audio("/sounds/background.mp3"),fire:new Audio("/sounds/fire.mp3"),explosion:new Audio("/sounds/explosion.wav"),gameOver:new Audio("/sounds/gameover.mp3")};l.background.loop=!0;l.background.volume=1;l.fire.volume=.1;l.explosion.volume=.1;l.gameOver.volume=.8;class oe{constructor(e,n,o=0,s=-5){this.x=e,this.y=n,this.dx=o,this.dy=s}update(){this.x+=this.dx,this.y+=this.dy}isOffScreen(){return this.y<-30}render(e,n){e.drawImage(n,this.x,this.y,30,30)}}let d=[];function se(){d=[]}function ie(){for(let t=d.length-1;t>=0;t--)d[t].update(),d[t].isOffScreen()&&d.splice(t,1)}function re(t,e){for(let n=0;n<d.length;n++)d[n].render(t,e)}function j(t){d.push(new oe(t.x+10,t.y,0,-5.2)),l.fire&&(l.fire.currentTime=0,l.fire.play())}class ae{constructor(e,n){this.x=e-25,this.y=n-25,this.animx=0,this.animy=0,l.explosion&&(l.explosion.currentTime=0,l.explosion.play())}update(){return this.animx+=.5,this.animx>7&&(this.animy++,this.animx=0),this.animy>7}render(e,n){e.drawImage(n,128*Math.floor(this.animx),128*Math.floor(this.animy),128,128,this.x,this.y,100,100)}}let f=[];function le(){f=[]}function de(t,e){f.push(new ae(t,e))}function ce(){for(let t=f.length-1;t>=0;t--)f[t].update()&&f.splice(t,1)}function ue(t,e){for(let n=0;n<f.length;n++)f[n].render(t,e)}class he{constructor(e,n,o,s,i,a=0,g=Math.random()*.2-.1){this.x=e,this.y=n,this.dx=o,this.dy=s,this.scale=i,this.angle=a,this.dxangle=g}update(e,n){this.x+=this.dx,this.y+=this.dy,this.angle+=this.dxangle,(this.x<=0||this.x>=e-50)&&(this.dx*=-1)}isOffScreen(e){return this.y>=e+50}collidesWithShip(e){return Math.abs(this.x+25-e.x-25)<50&&Math.abs(this.y+25-e.y-25)<50}collidesWithFire(e){return Math.abs(this.x+25-e.x-15)<50&&Math.abs(this.y-e.y)<25}render(e,n){e.save(),e.translate(this.x+25,this.y+25),e.rotate(this.angle),e.drawImage(n,-25,-25,50,50),e.restore()}}let h=[];function me(){h=[]}let X=0;function fe(t,e){if(t%15===0){X++;const o=Math.min(3,Math.floor(X/600)),s=.5,i=.4,a=Math.random(),g=.8+Math.random()*.7;let E=Math.random()*2-1,u=Math.random()*2+1+o,v=Math.random()*550,I=-50;if(a<s){const K=e.x+25,J=e.y+25,F=Math.random()*600,q=-50,S=K-F,O=J-q,W=Math.sqrt(S*S+O*O);E=S/W*(2+o),u=O/W*(2+o),v=F,I=q}else a<s+i&&(u+=2+o);h.push(new he(v,I,E,u,g))}}function pe(t,e){try{for(let n=h.length-1;n>=0;n--){const o=h[n];if(o.update(600,650),o.isOffScreen(650)){h.splice(n,1);continue}for(let s=d.length-1;s>=0;s--)if(o.collidesWithFire(d[s])){de(o.x,o.y),d.splice(s,1),h.splice(n,1),r.score+=150;break}if(o.collidesWithShip(t)&&(h.splice(n,1),r.lives--,r.lives<=0)){e();return}}}catch(n){console.error("❌ Ошибка в updateAsteroids:",n),r.paused=!0,r.gameOver=!0;const o=canvas.getContext("2d");o.fillStyle="red",o.font="20px Arial",o.fillText("⚠️ Ошибка в астероидах. Игра остановлена.",30,80)}}function ye(t,e){for(const n of h)n.render(t,e)}class B{constructor(e,n){this.x=Math.random()*e,this.y=Math.random()*n,this.size=Math.random()*2+1,this.speed=Math.random()*1.5+.5,this.color=B.getRandomColor(),this.alphaPhase=Math.random()*Math.PI*2}static getRandomColor(){const e=["#ffffff","#aaddff","#ffccaa","#aaffee","#ddeeff"];return e[Math.floor(Math.random()*e.length)]}update(e){this.y+=this.speed,this.y>e&&(this.y=0,this.x=Math.random()*600),this.alphaPhase+=.05}render(e){const n=.5+.5*Math.sin(this.alphaPhase);e.fillStyle=B.hexToRgba(this.color,n),e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill()}static hexToRgba(e,n){const o=parseInt(e.slice(1),16),s=o>>16&255,i=o>>8&255,a=o&255;return`rgba(${s}, ${i}, ${a}, ${n.toFixed(2)})`}}class P{constructor(e,n){this.x=Math.random()*e,this.y=Math.random()*n,this.radius=100+Math.random()*100,this.color=P.getRandomColor(),this.alpha=.05+Math.random()*.1}static getRandomColor(){const e=["rgba(128,0,255,","rgba(0,255,255,","rgba(255,100,0,"];return e[Math.floor(Math.random()*e.length)]}render(e){const n=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);n.addColorStop(0,this.color+this.alpha+")"),n.addColorStop(1,this.color+"0)"),e.fillStyle=n,e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.fill()}}class ge{constructor(e=600,n=600,o=120,s=5){this.width=e,this.height=n,this.stars=Array.from({length:o},()=>new B(e,n)),this.nebulas=Array.from({length:s},()=>new P(e,n))}update(){this.stars.forEach(e=>e.update(this.height))}render(e){const n=e.createLinearGradient(0,0,0,this.height);n.addColorStop(0,"#000010"),n.addColorStop(1,"#12003a"),e.fillStyle=n,e.fillRect(0,0,this.width,this.height),this.nebulas.forEach(o=>o.render(e)),this.stars.forEach(o=>o.render(e))}}const Y=new ge;function we(){Y.update()}function xe(t){Y.render(t)}const D="https://space-shooter-yua3.onrender.com";function y(t){const n=document.getElementById(t).content.cloneNode(!0);document.body.appendChild(n)}y("registration-template");y("score-template");y("end-template");y("pause-template");y("help-template");y("about-template");const G=document.querySelectorAll("#menu button"),Me=G[0],be=G[1],Ee=document.getElementById("playerName"),$=document.getElementById("overlay"),N=document.getElementById("endModal"),ve=document.querySelectorAll("#menu button")[2],A=document.getElementById("helpModal"),Ie=document.getElementById("helpInput"),Be=document.getElementById("helpSubmitBtn"),x=document.getElementById("aboutModal"),Ae=document.getElementById("closeAbout"),Le=document.getElementById("aboutBtn"),L=document.getElementById("scoreModal");Me.addEventListener("click",function(){const t=Ee.value.trim();if(t===""){alert("Пожалуйста, введите имя игрока!");return}r.playerName=t,$.style.display="none",N.style.display="none",z()});be.addEventListener("click",function(){const t=document.getElementById("scoreList");t.innerHTML="",L.style.display="block",ke()});document.getElementById("closeModal").onclick=function(){L.style.display="none"};document.getElementById("restartGameBtn").addEventListener("click",()=>{z()});document.getElementById("returnToMenuBtn").addEventListener("click",()=>{N.style.display="none",$.style.display="block"});document.addEventListener("keydown",function(t){if(t.key==="Escape"){const e=document.getElementById("pauseModal");if(A.style.display==="block"){A.style.display="none";return}if(L.style.display==="block"){L.style.display="none";return}if(x&&x.style.display==="block"){x.style.display="none";return}$.style.display==="none"&&!r.gameOver&&(r.paused?(r.paused=!1,e.style.display="none"):(r.paused=!0,e.style.display="block"))}});ve.addEventListener("click",()=>{A.style.display="block",Ie.value=""});document.getElementById("closeHelpModal").addEventListener("click",()=>{A.style.display="none"});async function ke(){const t=document.getElementById("scoreList"),e=document.getElementById("loader");t.classList.add("hidden"),e.classList.remove("hidden");try{const n=await fetch(`${D}/api/scores`);if(!n.ok)throw new Error(`Ошибка сервера: ${n.status}`);const o=await n.json();if(!Array.isArray(o))throw new Error("Ответ не является массивом");setTimeout(()=>{t.innerHTML="",o.forEach((s,i)=>{const a=document.createElement("li");a.textContent=`${i+1}. ${s.name} — ${s.score} очков`,t.appendChild(a)}),e.classList.add("hidden"),t.classList.remove("hidden")},2e3)}catch(n){console.error("❌ Ошибка при загрузке рекордов:",n),e.classList.add("hidden"),t.classList.remove("hidden"),t.innerHTML="<li>Ошибка загрузки данных</li>"}}Le.addEventListener("click",()=>{x.style.display="block"});Ae.addEventListener("click",()=>{x.style.display="none"});Be.addEventListener("click",async()=>{var o,s,i;const t=(o=document.getElementById("helpName"))==null?void 0:o.value.trim(),e=(s=document.getElementById("helpEmail"))==null?void 0:s.value.trim(),n=(i=document.getElementById("helpInput"))==null?void 0:i.value.trim();if(!t||!e||!n){alert("Пожалуйста, заполните все поля.");return}try{const a=await fetch(`${D}/api/help`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:e,message:n})});if(!a.ok)throw new Error(`Ошибка сервера: ${a.status}`);await a.json(),alert("Ваше сообщение отправлено!"),document.getElementById("helpModal").style.display="none"}catch(a){console.error("❌ Ошибка отправки:",a),alert("Произошла ошибка при отправке. Попробуйте позже.")}});const Se="https://space-shooter-yua3.onrender.com",c=new ee,b=document.getElementById("game"),m=b.getContext("2d"),M={w:!1,a:!1,s:!1,d:!1,ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1};let C=!0;document.addEventListener("keydown",t=>{if(!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(t.key in M&&(M[t.key]=!0,C=!1),t.code==="Space")){const e=Date.now();e-k>H&&!r.paused&&!r.gameOver&&(j(c),k=e),t.preventDefault()}});document.addEventListener("keyup",t=>{t.key in M&&(M[t.key]=!1)});c.moveWithMouse(b,()=>C,t=>C=t);let w={},R,k=0;const H=500;function Oe(){l.background&&(l.background.loop=!0,l.background.volume=.3,l.background.play().catch(()=>{console.warn("Фоновая музыка не может быть воспроизведена автоматически")}))}var Te=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/20)}}();function Ce(){R=0,b.addEventListener("mousedown",function(t){const e=Date.now();t.button===0&&e-k>H&&!r.paused&&!r.gameOver&&(j(c),k=e)})}function U(){try{if(r.gameOver)return;r.paused||(Re(),Pe()),Te(U)}catch(t){console.error("❌ Ошибка в игровом цикле:",t),r.paused=!0,r.gameOver=!0;const e=b.getContext("2d");e.fillStyle="red",e.font="20px Arial",e.fillText("⚠️ Ошибка! Игра остановлена.",30,50)}}function Re(){we(),R++,c.moveWithKeyboard(M,b),fe(R,c),ie(),pe(c,$e),ce()}function Pe(){m.clearRect(0,0,600,600),xe(m),re(m,w.fire),m.drawImage(w.ship,c.x,c.y),ye(m,w.aster),ue(m,w.expl),Z()}function $e(){r.gameOver=!0;let t=r.playerName||"Безымянный",e=r.score;_(e),Fe(t,e),l.background&&(l.background.pause(),l.background.currentTime=0),l.gameOver&&(l.gameOver.currentTime=0,l.gameOver.play())}function Ne(t){w=t,V(t)}function z(){Oe(),r.score=0,r.lives=3,r.paused=!1,r.gameOver=!1,me(),se(),le(),c.reset(),N.style.display="none",Ce(),Q(m),U()}function Fe(t,e){fetch(`${Se}/api/score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,score:e})}).then(n=>n.json()).catch(n=>{console.error("❌ Ошибка при сохранении:",n)})}(async()=>{try{const t=await ne();Ne(t)}catch(t){console.error("❌ Ошибка загрузки изображений:",t)}})();
